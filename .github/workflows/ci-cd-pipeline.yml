
name: ðŸš€ CI/CD Pipeline ComplÃ¨te

on:
  push:
   branches: [ main, develop ]
  pull_request:
   branches: [ main ]

env:
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

jobs:
  # Ã‰tape 1: Tests Backend
  backend-tests:
    name: ðŸ§ª Tests Backend & Coverage
    uses: ./.github/workflows/backend-tests-coverage.yml
    secrets: inherit

  # Ã‰tape 2: Tests Frontend
  frontend-tests:
    name: ðŸŽ¨ Tests Frontend & Coverage
    uses: ./.github/workflows/frontend-tests-coverage.yml
    secrets: inherit

  # Ã‰tape 3: Analyse QualitÃ© Backend et Frontend (dÃ©clenchÃ©e si tests OK)
  sonar-quality-check:
    name: ðŸ“Š SonarCloud Quality Check 
    needs: [backend-tests, frontend-tests]
    if: success() && needs.backend-tests.result == 'success' && needs.frontend-tests.result == 'success'
    uses: ./.github/workflows/sonarcloud_quality_check.yml
    secrets: inherit

 
  # Ã‰tape 4: Build & Push Docker (dÃ©clenchÃ©e si qualitÃ© OK)
  docker-build:
    name: Build & Push Docker Hub
    needs: [sonar-quality-check]
    # If: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.sonar-quality-check.result == 'success'

    if: github.event_name == 'pull_request' && needs.sonar-quality-check.result == 'success'

    uses: ./.github/workflows/docker.yml
    secrets: inherit